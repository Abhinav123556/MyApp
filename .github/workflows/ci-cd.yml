name: .NET 10 & Angular 21 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '10.0.101'
  NODE_VERSION: '20.19.6'

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    # Step 1: Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # Step 2: Setup .NET 10
    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # Step 3: Setup Node.js 20 LTS (Angular-supported)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    # Step 4: Restore .NET dependencies
    - name: Restore .NET dependencies
      run: dotnet restore ./backend/MyApp.API.csproj

    # Step 5: Build .NET project
    - name: Build .NET project
      run: dotnet build ./backend/MyApp.API.csproj --configuration Release --no-restore

    # Step 6: Run .NET tests
    - name: Run .NET tests
      run: dotnet test ./backend/MyApp.API.csproj --configuration Release --no-build
      continue-on-error: true

    # Step 7: Install Angular CLI
    - name: Install Angular CLI
      run: npm install -g @angular/cli@21.0.3

    # Step 8: Install Angular dependencies (SAFE)
    - name: Install Angular dependencies
      run: npm ci
      working-directory: ./frontend

    # Step 9: Build Angular 21 project
    - name: Build Angular project
      run: ng build --configuration=production
      working-directory: ./frontend

    # Step 10: Run Angular tests
    - name: Run Angular tests
      run: ng test --watch=false --browsers=ChromeHeadless
      working-directory: ./frontend
      continue-on-error: true

    # Step 11: Create deployment artifacts
    - name: Create deployment artifacts
      run: |
        mkdir artifacts
        mkdir artifacts/wwwroot

        dotnet publish ./backend/MyApp.API.csproj `
          --configuration Release `
          --output ./artifacts `
          --no-restore

        Copy-Item -Path "frontend/dist/**" -Destination "artifacts/wwwroot/" -Recurse -Force

        @"
        DEPLOYMENT PACKAGE
        =================
        Application: MyApp
        Created: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        .NET Version: ${{ env.DOTNET_VERSION }}
        Node.js Version: ${{ env.NODE_VERSION }}
        Angular CLI: 21.0.3
        Commit: ${{ github.sha }}
        "@ | Out-File artifacts/deployment-info.txt -Encoding UTF8

    # Step 12: Upload artifacts
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: myapp-build-${{ github.run_number }}
        path: artifacts/
        retention-days: 7
